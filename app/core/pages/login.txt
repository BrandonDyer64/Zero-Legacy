<?php

if ($page == "login") {

   if (isset($_POST["submit"])) {
      if ($_POST["username"] == "admin" && $_POST["password"] == $config["admin"]["password"]) {
         $_SESSION["logged_in"] = true;
         $_SESSION["username"] = "admin";
         $_SESSION['user_groups'] = ['admin'];
         if (isset($_GET['p']) && $_GET['p'] == "login") {
            header("Location: ?p=home");
         } else {
            header("Refresh:0");
         }
      } else {
         $stmt = db_select('user', ['*'], ['username'=>$_POST['username'], 'password'=>md5($_POST['password'] . SALT . $_POST['username'])]);
         $_SESSION["logged_in"] = false;
         while ($row = $stmt->fetch()) {
            $groups = get_multi_select_names('user_group', $row['user_groups']);
            $_SESSION["logged_in"] = true;
            $_SESSION['username'] = $row['username'];
            $_SESSION['user_id'] = $row['id'];
            $_SESSION['email'] = $row['email'];
            $_SESSION['token'] = $row['password'];
            $_SESSION['user_groups'] = $groups;
         }
         if (isset($_GET['p']) && $_GET['p'] == "login") {
            header("Location: ?p=home");
         } else {
            header("Refresh:0");
         }
      }
   } else if (isset($_POST["submit_register"])) {
      $stmt = db_select('user',['*'],['username'=>$_POST['username']]);
      if ($stmt->fetch()) {
         $content .= "<p>Username taken</p>";
      } else {
         $stmt = db_select('user_group',['id'],['name'=>'user']);
         $row = $stmt->fetch();
         $user_group_id = $row['id'];
         db_insert('user', [
               'username'=>$_POST['username'],
               'password'=>md5($_POST['password'] . SALT . $_POST['username']),
               'email'=>$_POST['email'],
               'user_groups'=>"$user_group_id"
            ]);
         $content .= "<p>Registered</p>";
      }
   }
   $content .= <<<HTML

   <div class="container-center animated slideInDown">
      <div class="view-header">
          <div class="header-icon">
              <i class="pe page-header-icon pe-7s-unlock"></i>
          </div>
          <div class="header-title">
              <h3>Login</h3>
              <small>
                  Please enter your credentials to login.
              </small>
          </div>
      </div>

      <div class="panel panel-filled">
          <div class="panel-body">
              <form action="#" name="login_form" method="post" id="loginForm" novalidate="" _lpchecked="1">
                  <div class="form-group">
                      <label class="control-label" for="username">Username</label>
                      <input type="text" placeholder="username" title="Please enter you username" required="" value="" name="username" id="username" class="form-control" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAASCAYAAABSO15qAAAAAXNSR0IArs4c6QAAAPhJREFUOBHlU70KgzAQPlMhEvoQTg6OPoOjT+JWOnRqkUKHgqWP4OQbOPokTk6OTkVULNSLVc62oJmbIdzd95NcuGjX2/3YVI/Ts+t0WLE2ut5xsQ0O+90F6UxFjAI8qNcEGONia08e6MNONYwCS7EQAizLmtGUDEzTBNd1fxsYhjEBnHPQNG3KKTYV34F8ec/zwHEciOMYyrIE3/ehKAqIoggo9inGXKmFXwbyBkmSQJqmUNe15IRhCG3byphitm1/eUzDM4qR0TTNjEixGdAnSi3keS5vSk2UDKqqgizLqB4YzvassiKhGtZ/jDMtLOnHz7TE+yf8BaDZXA509yeBAAAAAElFTkSuQmCC&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%; cursor: auto;" autocomplete="off">
                  </div>
                  <div class="form-group">
                      <label class="control-label" for="password">Password</label>
                      <input type="password" title="Please enter your password" placeholder="******" required="" value="" name="password" id="password" class="form-control" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAASCAYAAABSO15qAAAAAXNSR0IArs4c6QAAAPhJREFUOBHlU70KgzAQPlMhEvoQTg6OPoOjT+JWOnRqkUKHgqWP4OQbOPokTk6OTkVULNSLVc62oJmbIdzd95NcuGjX2/3YVI/Ts+t0WLE2ut5xsQ0O+90F6UxFjAI8qNcEGONia08e6MNONYwCS7EQAizLmtGUDEzTBNd1fxsYhjEBnHPQNG3KKTYV34F8ec/zwHEciOMYyrIE3/ehKAqIoggo9inGXKmFXwbyBkmSQJqmUNe15IRhCG3byphitm1/eUzDM4qR0TTNjEixGdAnSi3keS5vSk2UDKqqgizLqB4YzvassiKhGtZ/jDMtLOnHz7TE+yf8BaDZXA509yeBAAAAAElFTkSuQmCC&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%;" autocomplete="off">
                  </div>
                  <div>
                      <input type="submit" name="submit" class="btn btn-accent" value="Login">
                      <a class="btn btn-default" href="#" onclick="document.getElementById('register_form').style.display = 'block';">Register</a>
                  </div>
              </form>
          </div>
      </div>

      <div id="register_form" style="display: none;">
         <div class="view-header">
             <div class="header-icon">
                 <i class="pe page-header-icon pe-7s-unlock"></i>
             </div>
             <div class="header-title">
                 <h3>Register</h3>
             </div>
         </div>

         <div class="panel panel-filled">
             <div class="panel-body">
                 <form action="#" name="register_form" method="post" id="registerForm" novalidate="" _lpchecked="1">
                     <div class="form-group">
                         <label class="control-label" for="username">Username</label>
                         <input type="text" placeholder="username" title="Please enter you username" required="" value="" name="username" id="username" class="form-control" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAASCAYAAABSO15qAAAAAXNSR0IArs4c6QAAAPhJREFUOBHlU70KgzAQPlMhEvoQTg6OPoOjT+JWOnRqkUKHgqWP4OQbOPokTk6OTkVULNSLVc62oJmbIdzd95NcuGjX2/3YVI/Ts+t0WLE2ut5xsQ0O+90F6UxFjAI8qNcEGONia08e6MNONYwCS7EQAizLmtGUDEzTBNd1fxsYhjEBnHPQNG3KKTYV34F8ec/zwHEciOMYyrIE3/ehKAqIoggo9inGXKmFXwbyBkmSQJqmUNe15IRhCG3byphitm1/eUzDM4qR0TTNjEixGdAnSi3keS5vSk2UDKqqgizLqB4YzvassiKhGtZ/jDMtLOnHz7TE+yf8BaDZXA509yeBAAAAAElFTkSuQmCC&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%; cursor: auto;" autocomplete="off">
                         <span class="help-block small">Your unique username to app</span>
                     </div>
                     <div class="form-group">
                         <label class="control-label" for="email">Email</label>
                         <input type="text" placeholder="example@gmail.com" title="Please enter you email" required="" value="" name="email" id="username" class="form-control" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAASCAYAAABSO15qAAAAAXNSR0IArs4c6QAAAPhJREFUOBHlU70KgzAQPlMhEvoQTg6OPoOjT+JWOnRqkUKHgqWP4OQbOPokTk6OTkVULNSLVc62oJmbIdzd95NcuGjX2/3YVI/Ts+t0WLE2ut5xsQ0O+90F6UxFjAI8qNcEGONia08e6MNONYwCS7EQAizLmtGUDEzTBNd1fxsYhjEBnHPQNG3KKTYV34F8ec/zwHEciOMYyrIE3/ehKAqIoggo9inGXKmFXwbyBkmSQJqmUNe15IRhCG3byphitm1/eUzDM4qR0TTNjEixGdAnSi3keS5vSk2UDKqqgizLqB4YzvassiKhGtZ/jDMtLOnHz7TE+yf8BaDZXA509yeBAAAAAElFTkSuQmCC&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%; cursor: auto;" autocomplete="off">
                         <span class="help-block small">Your email address</span>
                     </div>
                     <div class="form-group">
                         <label class="control-label" for="password">Password</label>
                         <input type="password" title="Please enter your password" placeholder="******" required="" value="" name="password" id="password" class="form-control" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAASCAYAAABSO15qAAAAAXNSR0IArs4c6QAAAPhJREFUOBHlU70KgzAQPlMhEvoQTg6OPoOjT+JWOnRqkUKHgqWP4OQbOPokTk6OTkVULNSLVc62oJmbIdzd95NcuGjX2/3YVI/Ts+t0WLE2ut5xsQ0O+90F6UxFjAI8qNcEGONia08e6MNONYwCS7EQAizLmtGUDEzTBNd1fxsYhjEBnHPQNG3KKTYV34F8ec/zwHEciOMYyrIE3/ehKAqIoggo9inGXKmFXwbyBkmSQJqmUNe15IRhCG3byphitm1/eUzDM4qR0TTNjEixGdAnSi3keS5vSk2UDKqqgizLqB4YzvassiKhGtZ/jDMtLOnHz7TE+yf8BaDZXA509yeBAAAAAElFTkSuQmCC&quot;); background-repeat: no-repeat; background-attachment: scroll; background-size: 16px 18px; background-position: 98% 50%;" autocomplete="off">
                         <span class="help-block small">Your strong password</span>
                     </div>
                     <div>
                         <input type="submit" name="submit_register" class="btn btn-accent" value="Register">
                     </div>
                 </form>
             </div>
         </div>
      </div>

   </div>

HTML;
/*
   $content .= <<<HTML

   <div>
      <div class="error error_message">You must be logged in to access this page.</div>

      <h2>Log in</h2>

      <form action="#" name="login_form" method="post">
         <table class="login" cellpadding="4">
            <tbody>
            <tr>
               <td>Username:</td>
               <td>
                  <input type="text" name="username" value="" maxlength="20" class="text" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGP6zwAAAgcBApocMXEAAAAASUVORK5CYII=&quot;); cursor: auto;" autocomplete="off">
               </td>
            </tr>
            <tr>
               <td>Password:</td>
               <td>
                  <input type="password" name="password" value="" maxlength="20" class="text" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGP6zwAAAgcBApocMXEAAAAASUVORK5CYII=&quot;); cursor: auto;" autocomplete="off">
               </td>
            </tr>
            <!--<tr><td colspan="2"><input type="checkbox" name="remember_username">&nbsp;&nbsp;Remember my username on this computer</td></tr>-->
            <tr><td colspan="2"><center><input type="submit" name="submit" value="Login" class="button"></center></td></tr>
            </tbody>
         </table>
      </form>
      <p><a href="?p=forgot_password">Forgot your password?</a></p>
      <p><a href="#" onclick="document.getElementById('register_form').style.display = 'block';">Register</a></p>
   </div>
   <div id="register_form" style="display: none;">
      <h2>Register</h2>

      <form action="#" name="register_form" method="post">
         <table class="login" cellpadding="4">
            <tbody>
            <tr>
               <td>Username:</td>
               <td>
                  <input type="text" name="username" value="" maxlength="20" class="text" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGP6zwAAAgcBApocMXEAAAAASUVORK5CYII=&quot;); cursor: auto;" autocomplete="off">
               </td>
            </tr>
            <tr>
               <td>Password:</td>
               <td>
                  <input type="password" name="password" value="" class="text" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGP6zwAAAgcBApocMXEAAAAASUVORK5CYII=&quot;); cursor: auto;" autocomplete="off">
               </td>
            </tr>
            <tr>
               <td>Email:</td>
               <td>
                  <input type="email" name="email" value="" class="text" placeholder="We Don't Spam" style="background-image: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGP6zwAAAgcBApocMXEAAAAASUVORK5CYII=&quot;); cursor: auto;" autocomplete="off">
               </td>
            </tr>
            <!--<tr><td colspan="2"><input type="checkbox" name="remember_username">&nbsp;&nbsp;Remember my username on this computer</td></tr>-->
            <tr><td colspan="2"><center><input type="submit" name="submit_register" value="Register" class="button"></center></td></tr>
            </tbody>
         </table>
      </form>
   </div>

HTML;
*/
}