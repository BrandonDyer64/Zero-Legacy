<?php

if ($page == "list") {
    if (!isset($_GET['t'])) {
        $content .= create_error('No table specified');
    }

    $table_data = db_table_data($table);
    check_user_permission_force($table_data['whitelist'], $table_data['whitelist_display']);

    $is_can_edit = check_user_permission($table_data['whitelist_edit']);
    $is_can_add = check_user_permission($table_data['whitelist_add']);

    $table_header = "<th></th>";
    $table_content = "";
    $list_content = '';
    $table_footer = "";

    if (isset($_GET['where'])) {
        if (is_array($_GET['where'])) {
            $where = $_GET['where'];
        } else {
            $where = json_decode($_GET['where'], true);
        }
    } else {
        $where = ["1"=>"1"];
    }

    if (isset($_GET['cols'])) {
        $cols = json_decode($_GET['cols'], true);
    } else {
        $cols = ['*'];
    }

    $schema = db_schema($table);
    $stmt = db_select($table, $cols, $where, 'ORDER BY id DESC');
    $i = 0;
    $first = true;
    $is_warn_for_id = false;
    while ($row = $stmt->fetch()) {
        $i++;
        $table_row = "";
        foreach ($row as $key => $value) {
            $fn = get_type_function('decode_list', $schema[$key]['type']);
            $value = $fn($schema[$key], $value, '', $row);
            $table_row .= "<td>$value</td>";
        }
        if (!isset($row['id'])) {
            $row['id'] = 0;
            // Show a warning about not having an id
            $is_warn_for_id = true;
        }
        $table_content .= <<<HTML

        <tr class='list_table_data_row'>
            <td align="left" valign="center">
                <a href="?p=display&t=$table&id={$row['id']}" title="View"><span class="glyphicon glyphicon-eye-open"></span></a>
                &nbsp;
                <a href="?p=edit&t=$table&id={$row['id']}" title="Edit"><span class="glyphicon glyphicon-edit"></a>
                &nbsp;
                <a href="?p=delete&t=$table&id={$row['id']}" title="Delete"><span class="glyphicon glyphicon-remove"></a>
            </td>
            $table_row
        </tr>

HTML;

        if ($first) {
            foreach ($row as $key => $value) {
                $key = column_pretty_print($key);
                $table_header .= "<th class='footable-sortable'>$key<span class='footable-sort-indicator'></span></th>";
            }
            $first = false;
        }
        if ($i % 20 == 0) {
            $table_content .= $table_header;
        }
    }

    $list_content .= <<<HTML
    <div class="card-box">
        <h4 class="m-t-0 header-title">Filtering</h4>
        <p class="text-muted m-b-30 font-13">
            include filtering in your FooTable.
        </p>
        <div class="form-inline m-b-20">
          <div class="row">
              <div class="col-md-6 text-xs-center">
                  <div class="form-group">
                      <label class="control-label m-r-5">Status</label>
                      <select id="demo-foo-filter-status" class="form-control input-sm">
                          <option value="">Show all</option>
                          <option value="active">Active</option>
                          <option value="disabled">Disabled</option>
                          <option value="suspended">Suspended</option>
                      </select>
                  </div>
              </div>
              <div class="col-md-6 text-center text-right">
                  <div class="form-group float-right">
                      <input id="demo-foo-search" type="text" placeholder="Search" class="form-control" autocomplete="on">
                  </div>
              </div>
          </div>
        </div>
        <table id="demo-foo-filtering" class="table table-striped table-bordered toggle-circle m-b-0 default footable-loaded footable no-paging" data-page-size="7">
          <thead>
            <tr class="list_table_header_row">
                $table_header
            </tr>
          </thead>
          <tbody>
              $table_content
              <tr class="list_table_totals_row">
                  $table_footer
              </tr>
          </tbody>
      </table>
    </div>
HTML;

    if ($is_warn_for_id) {
        debug_warn('This table does not have an ID field');
    }

    if (!$first) {
        $content .= <<<HTML

        <h2>List: <b>$table_pretty</b></h2>

        <p><a href="?p=add&t=$table"><span class="glyphicon glyphicon-plus"></span></a></p>

        $list_content

HTML;
    } else {
        $content .= <<<HTML
        <h1><strong>: (</strong> &nbsp; Empty Set</h1>
        <p><a href="?p=add&t=$table">Create the First One</a></p>
HTML;
    }
}

/*
<div class="row">
                            <div class="col-12">
                                <div class="card-box">
                                    <h4 class="m-t-0 header-title">Filtering</h4>
                                    <p class="text-muted m-b-30 font-13">
                                        include filtering in your FooTable.
                                    </p>

                                    <div class="form-inline m-b-20">
                                            <div class="row">
                                                <div class="col-md-6 text-xs-center">
                                                    <div class="form-group">
                                                        <label class="control-label m-r-5">Status</label>
                                                        <select id="demo-foo-filter-status" class="form-control input-sm">
                                                            <option value="">Show all</option>
                                                            <option value="active">Active</option>
                                                            <option value="disabled">Disabled</option>
                                                            <option value="suspended">Suspended</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 text-center text-right">
                                                    <div class="form-group float-right">
                                                        <input id="demo-foo-search" type="text" placeholder="Search" class="form-control" autocomplete="on">
                                                    </div>
                                                </div>
                                            </div>
                                        </div><table id="demo-foo-filtering" class="table table-striped table-bordered toggle-circle m-b-0 default footable-loaded footable no-paging" data-page-size="7">
                                        <thead>
                                        <tr>
                                            <th data-toggle="true" class="footable-visible footable-first-column footable-sortable">First Name<span class="footable-sort-indicator"></span></th>
                                            <th class="footable-visible footable-sortable">Last Name<span class="footable-sort-indicator"></span></th>
                                            <th data-hide="phone" class="footable-visible footable-sortable">Job Title<span class="footable-sort-indicator"></span></th>
                                            <th data-hide="phone, tablet" class="footable-visible footable-sortable">DOB<span class="footable-sort-indicator"></span></th>
                                            <th data-hide="phone, tablet" class="footable-visible footable-last-column footable-sortable footable-sorted">Status<span class="footable-sort-indicator"></span></th>
                                        </tr>
                                        </thead>

                                        <tbody>






























                                        <tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Easer</td>
                                            <td class="footable-visible">Dragoo</td>
                                            <td class="footable-visible">Drywall Stripper</td>
                                            <td class="footable-visible">13 Dec 1977</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-success">Active</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Easer</td>
                                            <td class="footable-visible">Dragoo</td>
                                            <td class="footable-visible">Drywall Stripper</td>
                                            <td class="footable-visible">13 Dec 1977</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-success">Active</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Easer</td>
                                            <td class="footable-visible">Dragoo</td>
                                            <td class="footable-visible">Drywall Stripper</td>
                                            <td class="footable-visible">13 Dec 1977</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-success">Active</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Isidra</td>
                                            <td class="footable-visible">Boudreaux</td>
                                            <td class="footable-visible">Traffic Court Referee</td>
                                            <td class="footable-visible">22 Jun 1972</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-success">Active</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Isidra</td>
                                            <td class="footable-visible">Boudreaux</td>
                                            <td class="footable-visible">Traffic Court Referee</td>
                                            <td class="footable-visible">22 Jun 1972</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-success">Active</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Isidra</td>
                                            <td class="footable-visible">Boudreaux</td>
                                            <td class="footable-visible">Traffic Court Referee</td>
                                            <td class="footable-visible">22 Jun 1972</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-success">Active</span></td>
                                        </tr><tr class="footable-even" style="">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Judi</td>
                                            <td class="footable-visible">Badgett</td>
                                            <td class="footable-visible">Electrical Lineworker</td>
                                            <td class="footable-visible">23 Jun 1981</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-success">Active</span></td>
                                        </tr><tr class="footable-odd" style="">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Judi</td>
                                            <td class="footable-visible">Badgett</td>
                                            <td class="footable-visible">Electrical Lineworker</td>
                                            <td class="footable-visible">23 Jun 1981</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-success">Active</span></td>
                                        </tr><tr class="footable-even" style="">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Judi</td>
                                            <td class="footable-visible">Badgett</td>
                                            <td class="footable-visible">Electrical Lineworker</td>
                                            <td class="footable-visible">23 Jun 1981</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-success">Active</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Maxine</td>
                                            <td class="footable-visible"><a href="#">Woldt</a></td>
                                            <td class="footable-visible"><a href="#">Business Services Sales Representative</a></td>
                                            <td class="footable-visible">17 Oct 1987</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-default">Disabled</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Shona</td>
                                            <td class="footable-visible">Woldt</td>
                                            <td class="footable-visible">Airline Transport Pilot</td>
                                            <td class="footable-visible">3 Oct 1981</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-default">Disabled</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Lorraine</td>
                                            <td class="footable-visible">Mcgaughy</td>
                                            <td class="footable-visible">Hemodialysis Technician</td>
                                            <td class="footable-visible">11 Nov 1983</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-default">Disabled</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Lorraine</td>
                                            <td class="footable-visible">Mcgaughy</td>
                                            <td class="footable-visible">Hemodialysis Technician</td>
                                            <td class="footable-visible">11 Nov 1983</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-default">Disabled</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Maxine</td>
                                            <td class="footable-visible"><a href="#">Woldt</a></td>
                                            <td class="footable-visible"><a href="#">Business Services Sales Representative</a></td>
                                            <td class="footable-visible">17 Oct 1987</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-default">Disabled</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Maxine</td>
                                            <td class="footable-visible"><a href="#">Woldt</a></td>
                                            <td class="footable-visible"><a href="#">Business Services Sales Representative</a></td>
                                            <td class="footable-visible">17 Oct 1987</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-default">Disabled</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Lorraine</td>
                                            <td class="footable-visible">Mcgaughy</td>
                                            <td class="footable-visible">Hemodialysis Technician</td>
                                            <td class="footable-visible">11 Nov 1983</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-default">Disabled</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Shona</td>
                                            <td class="footable-visible">Woldt</td>
                                            <td class="footable-visible">Airline Transport Pilot</td>
                                            <td class="footable-visible">3 Oct 1981</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-default">Disabled</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Shona</td>
                                            <td class="footable-visible">Woldt</td>
                                            <td class="footable-visible">Airline Transport Pilot</td>
                                            <td class="footable-visible">3 Oct 1981</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-default">Disabled</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Granville</td>
                                            <td class="footable-visible">Leonardo</td>
                                            <td class="footable-visible">Business Services Sales Representative</td>
                                            <td class="footable-visible">19 Apr 1969</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Lauri</td>
                                            <td class="footable-visible">Hyland</td>
                                            <td class="footable-visible">Blackjack Supervisor</td>
                                            <td class="footable-visible">15 Nov 1985</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Lizzee</td>
                                            <td class="footable-visible"><a href="#">Goodlow</a></td>
                                            <td class="footable-visible">Technical Services Librarian</td>
                                            <td class="footable-visible">1 Nov 1961</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Lizzee</td>
                                            <td class="footable-visible"><a href="#">Goodlow</a></td>
                                            <td class="footable-visible">Technical Services Librarian</td>
                                            <td class="footable-visible">1 Nov 1961</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Lauri</td>
                                            <td class="footable-visible">Hyland</td>
                                            <td class="footable-visible">Blackjack Supervisor</td>
                                            <td class="footable-visible">15 Nov 1985</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Lizzee</td>
                                            <td class="footable-visible"><a href="#">Goodlow</a></td>
                                            <td class="footable-visible">Technical Services Librarian</td>
                                            <td class="footable-visible">1 Nov 1961</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Granville</td>
                                            <td class="footable-visible">Leonardo</td>
                                            <td class="footable-visible">Business Services Sales Representative</td>
                                            <td class="footable-visible">19 Apr 1969</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Granville</td>
                                            <td class="footable-visible">Leonardo</td>
                                            <td class="footable-visible">Business Services Sales Representative</td>
                                            <td class="footable-visible">19 Apr 1969</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Lauri</td>
                                            <td class="footable-visible">Hyland</td>
                                            <td class="footable-visible">Blackjack Supervisor</td>
                                            <td class="footable-visible">15 Nov 1985</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Maple</td>
                                            <td class="footable-visible">Halladay</td>
                                            <td class="footable-visible">Aviation Tactical Readiness Officer</td>
                                            <td class="footable-visible">30 Dec 1991</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-even" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Maple</td>
                                            <td class="footable-visible">Halladay</td>
                                            <td class="footable-visible">Aviation Tactical Readiness Officer</td>
                                            <td class="footable-visible">30 Dec 1991</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr><tr class="footable-filtered footable-odd" style="display: none;">
                                            <td class="footable-visible footable-first-column"><span class="footable-toggle"></span>Maple</td>
                                            <td class="footable-visible">Halladay</td>
                                            <td class="footable-visible">Aviation Tactical Readiness Officer</td>
                                            <td class="footable-visible">30 Dec 1991</td>
                                            <td class="footable-visible footable-last-column"><span class="badge label-table badge-danger">Suspended</span></td>
                                        </tr></tbody>
                                        <tfoot>
                                        <tr class="active">
                                            <td colspan="5" class="footable-visible">
                                                <div class="text-right">
                                                    <ul class="pagination pagination-split justify-content-end footable-pagination m-t-10 m-b-0"><li class="footable-page-arrow disabled"><a data-page="first" href="#first">«</a></li><li class="footable-page-arrow disabled"><a data-page="prev" href="#prev">‹</a></li><li class="footable-page active"><a data-page="0" href="#">1</a></li><li class="footable-page-arrow disabled"><a data-page="next" href="#next">›</a></li><li class="footable-page-arrow disabled"><a data-page="last" href="#last">»</a></li></ul>
                                                </div>
                                            </td>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        */
